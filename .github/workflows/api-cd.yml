name: API Module CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["API Module CI - Build & Push Docker Image"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "âœ… EC2 ì ‘ì† ì™„ë£Œ. ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."

            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker pull ${{ secrets.DOCKER_USERNAME }}/tictoc-api:latest

            if ! docker network ls | grep -q tic-toc-net; then
              echo "ğŸ•¸ï¸ Docker ë„¤íŠ¸ì›Œí¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
              docker network create tic-toc-net
              echo "âœ… Docker ë„¤íŠ¸ì›Œí¬ ìƒì„± ì™„ë£Œ!"
            fi

            if ! docker ps --format '{{.Names}}' | grep -q redis; then
              echo "ğŸˆ Redisê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤. ì‹¤í–‰í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.yml up -d redis
              echo "âœ… Redis ì‹¤í–‰ ì™„ë£Œ!"
            else
              echo "ğŸˆ Redisê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            fi

            echo "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸..."
            if docker ps | grep -q tictoc-blue; then
              echo "ğŸ”µ Blue ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. Greenì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.backend.yml up -d tictoc-green

              until docker ps | grep -q tictoc-green; do
                echo "â³ Green ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸..."
                sleep 2
              done
              echo "âœ… Green ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"

              echo "ğŸ›‘ ê¸°ì¡´ Blue ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              docker stop tictoc-blue && docker rm tictoc-blue

              echo "ğŸ”µ Blue ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.backend.yml up -d tictoc-blue
            
              until docker ps | grep -q tictoc-blue; do
                echo "â³ Blue ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸..."
                sleep 2
              done
              echo "âœ… Blue ì»¨í…Œì´ë„ˆë„ ìƒˆ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"

            else
              echo "ğŸŸ¢ Green ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. Blueë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.backend.yml up -d tictoc-blue
            
              until docker ps | grep -q tictoc-blue; do
                echo "â³ Blue ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸..."
                sleep 2
              done
              echo "âœ… Blue ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤!"

              echo "ğŸ›‘ ê¸°ì¡´ Green ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."
              docker stop tictoc-green && docker rm tictoc-green

              echo "ğŸŸ¢ Green ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.backend.yml up -d tictoc-green
            
              until docker ps | grep -q tictoc-green; do
                echo "â³ Green ì»¨í…Œì´ë„ˆê°€ ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 2ì´ˆ í›„ ë‹¤ì‹œ í™•ì¸..."
                sleep 2
              done
              echo "âœ… Green ì»¨í…Œì´ë„ˆë„ ìƒˆ ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
            fi

            echo "ğŸ”„ Nginxê°€ ìë™ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ì¡°ì •í•©ë‹ˆë‹¤."
            sudo systemctl restart nginx
            echo "âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ!"


      - name: ğŸ—‘ï¸ Delete Unused Images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ—‘ï¸ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
            docker image prune -f
            echo "âœ… ì •ë¦¬ ì™„ë£Œ!"