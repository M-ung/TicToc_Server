name: API Module CD - Deploy to EC2

on:
  workflow_run:
    workflows: ["API Module CI - Build & Push Docker Image"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker pull ${{ secrets.DOCKER_USERNAME }}/tictoc-api:latest
            
            if ! docker network ls | grep -q tic-toc-net; then
              echo "Docker ë„¤íŠ¸ì›Œí¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤."
              docker network create tic-toc-net
            fi
            
            if ! docker ps --format '{{.Names}}' | grep -q redis; then
              echo "Redisê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤. ì‹¤í–‰í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.yml up -d redis
            else
              echo "Redisê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
            fi
            
            if docker ps | grep -q tictoc-blue; then
              echo "í˜„ì¬ Blueê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. Greenìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.green.yml up -d
              sleep 5
              sudo sed -i 's/proxy_pass http:\/\/blue;/proxy_pass http:\/\/green;/' /etc/nginx/conf.d/app.conf
              sudo systemctl restart nginx

              if docker ps -a --format '{{.Names}}' | grep -q tictoc-blue; then
                docker stop tictoc-blue && docker rm tictoc-blue
              fi

            else
              echo "í˜„ì¬ Greenì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. Blueë¡œ ë°°í¬í•©ë‹ˆë‹¤."
              docker-compose -f ~/tictoc-deploy/docker-compose.blue.yml up -d
              sleep 5
              sudo sed -i 's/proxy_pass http:\/\/green;/proxy_pass http:\/\/blue;/' /etc/nginx/conf.d/app.conf
              sudo systemctl restart nginx

              if docker ps -a --format '{{.Names}}' | grep -q tictoc-green; then
                docker stop tictoc-green && docker rm tictoc-green
              fi
            fi

            docker image prune -f

      - name: ğŸ—‘ï¸ Delete Unused Images
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ì‹¤í–‰ ì¤‘ì´ì§€ ì•Šì€ tictoc-api ë° redis ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            docker images | grep 'tictoc-api' | awk '{print $3}' | xargs -r docker rmi -f
            docker images | grep 'redis' | awk '{print $3}' | xargs -r docker rmi -f
            docker image prune -f
            echo "âœ… ì‚­ì œ ì™„ë£Œ!"